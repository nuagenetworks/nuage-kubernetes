
# Multi Master Kubernetes Setup

.. Note:: The steps documented to install the Multi Master Kubernetes Setup work with Kubernetes v1.6.6 or below

Setup etcd
-----------

 1. Copy the contents of the etcd folder from this repository to all the etcd nodes in the cluster ( Recommended etcd cluster of 3 nodes)
 2. Fill in the etcd cluster specific information in the etcd.env file
 3. For the first node, generate the token manually using the link in the etcd.env file
 4. For the 2nd & 3rd node in the cluster, set the CURRENT_NODE accordingly
 5. Once etcd.env is populated correctly, run the setup-etcd.sh script as shown below.
 6. Status of the etcd service can be checked using `service etcd status` command
 
 ```
 cp etcd_template.env etcd.env
 _Fill in node/cluster specific configuration_
 vim etcd.env
 chmod +x setup-etcd.sh
 ./setup-etcd.sh
```
Setup the Load balancer for the Kubernetes Masters
--------------------------------------------------

1. Install haproxy on the node acting as the Load balancer
2. Modify the haproxy.cfg to balance the 3 masters with the config shown in masters directory
3. Restart the haproxy service for the configuration to take effect

Setup base for the first Kubernetes Master
--------------------------------------------

1. Copy the contents from the master directory in this repository to the first master
2. Fill in the contents in the master.env file
3. The Token field will be set to blank for the first master
4. Run init-master.sh script as shown below

```
cp master_template.env master.env
_Fill in node/cluster specific configuration_
vim master.env
chmod +x setup-master.sh
_only needed on first master server and on first configuration_
chmod +x init-master.sh
./init-master.sh
```

Configure other Kubernetes Master servers
------------------------------------------

1. Before initializing the 2nd and 3rd masters, we need to run the kubeadm join command which is generated by the first master
2. In order to run the join command on the 2nd and 3rd masters, kubernetes packages need to be installed as follows:

```
    cat <<EOF > /etc/yum.repos.d/kubernetes.repo
    [kubernetes]
    name=Kubernetes
    baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    enabled=1
    gpgcheck=1
    repo_gpgcheck=1
    gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    EOF
    setenforce 0
    yum install -y docker
    systemctl enable docker && systemctl start docker
    yum install -y kubelet kubeadm kubectl
    systemctl enable kubelet && systemctl start kubelet
    sysctl net.bridge.bridge-nf-call-iptables=1
    
```

3. After the join command, kube-proxy pod should be created for both the masters and the masters will be listed as nodes on the first master and it should move to running state
4. Also, a unique kubelet.conf and bootstrap-kubelet.conf is generated for the 2nd and the 3rd masters
5. Copy the kubelet.conf and bootstrap-kubelet.conf to another location like /tmp/
6. run kubeadm reset on 2nd and 3rd master nodes
7. Copy the contents from the first Master in /etc/kubernetes directory to this Master in /etc/kubernetes directory except the kubelet.conf
8. Also, copy the kubelet.key and kubelet.crt from /var/lib/kubelet/pki on the first master to the 2nd and 3rd masters
9. Copy the kubelet.conf and bootstrap-kubelet.conf from the /tmp directory to the /etc/kubernetes/ directory on 2nd and 3rd masters
10. Restart the kubelet process using the command `service kubelet restart`
11. Mark the 2nd and 3rd masters by running the command `kubeadm alpha phase mark-master` on each of them

Configure the Kubernetes Nodes
------------------------------

1. Copy the contents from the node directory in this repository on all the nodes
2. Copy the token from the master.env file and populate it in the worker.env file
3. Set the correct SERVICE_SUBNET CIDR & POD_SUBNET CIDR
4. Run the setup-worker.sh script as shown below

```
_Fill in node/cluster specific configuration_
vim worker.env
chmod +x setup-worker.sh
./setup-worker.sh

```
**To install Nuage components on the cluster, follow the steps mentioned [here](https://github.com/nuagenetworks/nuage-kubernetes/blob/master/kubernetes-standalone-deployment/kubernetes-1-installation.rst#id2)** 

